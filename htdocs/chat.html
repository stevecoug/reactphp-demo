<!DOCTYPE html>
<html lang='en'>
<head>
	<title>PHP Websockets Chat Demo</title>
	<meta name='viewport' content='width=device-width, initial-scale=1.0' />
	<meta name='ROBOTS' content='ALL' />
	<meta charset="UTF-8" />
	<script src='//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>
	<script src='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.pack.js'></script>
	<script src='//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js'></script>
	<script src="/js/jquery.cookie.js"/></script>
	<link href='//cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.css' rel='styleSheet' type='text/css' />
	<link href='//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css' rel='styleSheet' type='text/css' />
	<link href='//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css' rel='styleSheet' type='text/css' />
</head>

<script type="text/javascript">
var conn = new WebSocket('ws://chat.local:8080/chat');
var msg_num = 0;
var user_color = "000000";
var user_name = "Me";

conn.onopen = function() {
	display_message("<b>SUCCESS: Established connection to chat server</b>");
}
conn.onerror = function() {
	display_message("<b>ERROR: Connection to chat server failed</b>");
}
conn.onclose = function() {
	display_message("<b>ERROR: Connection closed</b>");
}

conn.onmessage = function(e) {
	msg_num++;
	
	var data = $.parseJSON(e.data);
	var message = "";
	var style = "";
	
	switch (data.type) {
		case "chat":
			if (data.from) {
				message += "<b>["+data.from+"]</b> ";
			}
			message += escape_html(data.message);
			if (data.color) {
				style += "color:"+data.color+";";
			}
			if (data.italic) {
				style += "font-style: italic;";
			}
		break;
		
		case "auth":
			if (data.valid == true) {
				$("#auth").css("display", "none");
				$("#input").css("display", "block");
				$("#input-message").focus();
				
				user_name = data.name;
				user_color = data.color;
				
				$.cookie("demo_chat_name", user_name);
				$.cookie("demo_chat_color", user_color);
				$("#btn-logout").css("display", "inline");
				
				display_message("You are connected as: " + user_name, "font-style: italic;");
			}
		break;
		
		case "error":
			message = "ERROR: " + data.error;
			style = "font-weight: bold; color: red;";
		break;
		
		default:
			message = "Unknown message type: " + escape_html(data.type);
		break;
	}
	
	if (message != "") {
		display_message(message, style);
	}
}

function escape_html(str) {
	return $("<div/>").text(str).html();
}

function send_chat() {
	var message = $("#input-message").val();
	$("#input-message").val("").focus();
	send_message({
		"type": "chat",
		"message": message
	});
	display_message("<b>[" + user_name + "]</b> " + message, "font-style: italic; color: #" + user_color);
}

function send_message(payload) {
	conn.send(JSON.stringify(payload));
}

function display_message(msg, style) {
	var div = "<div id='msg" + msg_num + "'";
	if (style !== "") div += " style='" + style + "'";
	div += "/>\n";
	$("#output").prepend($(div).html(msg));
	$("#msg"+msg_num).show(300);
}

function authenticate() {
	send_message({
		"type": "auth",
		"name": $("#auth-name").val(),
		"color": $("#auth-color").val()
	});
}
function logout() {
	$.removeCookie("demo_chat_name");
	$.removeCookie("demo_chat_color");
	return true;
}

$(function() {
	$("#auth-color").colorPicker();
	$("#input-message").on("keypress", function(e) {
		if (e.keyCode === 13) {
			send_chat();
		}
	});
});
</script>

<style type="text/css">
div#output > div {
	border-top: 1px solid #d0d0d0;
	display: none;
}
div#output > div:first-child { border-top: none; }
div#input { display: none; }
div.colorPicker-picker { display: inline-block; }
a#btn-logout { display: none; }
</style>

<body>
<div class="well">
	<h1>Welcome to the chat demo</h1>
	
	<a href="/" class="btn">Home</a>
	<a href="/chat.html" class="btn btn-success">Refresh</a>
	<a href="/chat.html" id="btn-logout" class="btn btn-danger" onclick="return logout();">Log out</a>
</div>

<div id="output" style="height: 400px"></div>

<div id="auth">
	Display name: <input type="text" class="span2" id="auth-name" value="" />
	<input type="text" class="span1" id="auth-color" value="#000000" />
	<a href="javascript:void(0)" onclick="authenticate(); return false;" class="btn btn-primary">Start</a>
</div>

<div id="input">
	<input type="text" class="span8" id="input-message" value="" placeholder="Enter your message here, then press Enter" />
</div>


</body>
</html>
